<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Force Calibration Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 10px; background-color: #f8f9fa; color: #333; margin: 0; }
        .container { max-width: 100%; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-area { text-align: center; margin-bottom: 12px; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
        h2 { color: #007bff; font-size: 1.2rem; margin: 0; }
        .creator-tag { color: #adb5bd; font-size: 0.75rem; font-weight: bold; margin-top: 3px; display: block; }
        .section { margin-bottom: 10px; padding: 10px; border: 1px solid #e9ecef; border-radius: 10px; background: #fff; }
        .section-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        
        /* --- ÏÑ†ÌÉùÏ∞Ω(Select) Î∞è ÏòµÏÖò ÌñâÍ∞Ñ Ï∂ïÏÜå --- */
        input, select { 
            width: 100%; 
            height: 28px; /* Í∏∞Ï°¥ 35px -> 28pxÎ°ú Ï∂ïÏÜå */
            padding: 2px 8px; 
            border: 1px solid #ced4da; 
            border-radius: 5px; 
            font-size: 13px; /* Ìè∞Ìä∏ ÏïΩÍ∞Ñ Ï∂ïÏÜå */
            box-sizing: border-box;
            line-height: 1; /* ÌñâÍ∞Ñ ÏµúÏÜåÌôî */
        }
        option {
            padding: 0px; 
            line-height: 1; /* Î¶¨Ïä§Ìä∏ ÎÇ¥Î∂Ä ÌñâÍ∞Ñ Ï∂ïÏÜå ÏãúÎèÑ */
        }
        .select-group { margin-bottom: 6px; } /* ÏÑ†ÌÉù ÏÉÅÏûêÎì§ ÏÇ¨Ïù¥ Í∞ÑÍ≤© Ï∂ïÏÜå */

        .btn-group { display: flex; gap: 4px; }
        .table-wrapper { overflow-x: auto; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; min-width: 280px; }
        th, td { border: 1px solid #dee2e6; padding: 4px 2px; text-align: center; font-size: 0.8rem; }
        th { background: #f1f3f5; }
        
        .btn-calc { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 8px; }
        .btn-share { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 8px; display: none; }
        .btn-reset, .btn-toggle, .btn-upload { padding: 3px 6px; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.7rem; white-space: nowrap; }
        .btn-reset { background: #dc3545; }
        .btn-toggle { background: #007bff; }
        .btn-upload { background: #6f42c1; }

        #result-area { margin-top: 5px; }
        .result-item { padding: 10px; margin-bottom: 6px; border-left: 5px solid #28a745; background: #f4faf6; border-radius: 6px; font-size: 0.85rem; line-height: 1.3; }
        .error-text { font-weight: bold; font-size: 1rem; }
        .info-section { display: none; margin-top: 10px; padding-top: 8px; border-top: 1px dashed #ced4da; }
        .info-group { margin-bottom: 6px; }
        .info-group label { display: block; font-size: 0.75rem; font-weight: bold; color: #666; margin-bottom: 2px; }
        
        .conv-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 5px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-area">
        <h2>FORCE CALIBRATION CALCULATOR</h2>
        <span class="creator-tag">Created by D</span>
    </div>

    <div class="section">
        <div class="section-title">
            <span>1Îã®Í≥Ñ Í∏∞Ï§ÄÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï</span>
            <div class="btn-group">
                <button class="btn-upload" onclick="triggerFileUpload()">ÌååÏùºÏ≤®Î∂Ä</button>
                <input type="file" id="excel-input" style="display:none" accept=".xlsx, .xls" onchange="processExcel(this)">
                <button id="toggle-row-btn" class="btn-toggle" onclick="toggleRows()">10Ïπ∏</button>
                <button class="btn-reset" onclick="resetTable('cal-table')">Ï¥àÍ∏∞Ìôî</button>
            </div>
        </div>
        <div class="select-group">
            <select id="load-cell-db" onchange="applyLoadCell()">
                <option value="">-- Í∏∞Ï§Ä Ïû•ÎπÑ ÏÑ†ÌÉù (DB Î°úÎìú) --</option>
            </select>
        </div>
        <div class="select-group">
            <select id="ref-unit-sel">
                <option value="kn">kN (ÌÇ¨Î°úÎâ¥ÌÑ¥)</option>
                <option value="n">N (Îâ¥ÌÑ¥)</option>
            </select>
        </div>
        <div class="table-wrapper">
            <table id="cal-main-table"><thead id="cal-thead"></thead><tbody id="cal-table"></tbody></table>
        </div>
    </div>

    <div class="section">
        <div class="section-title"><span>2Îã®Í≥Ñ Ï∏°Ï†ïÍ∞í ÏûÖÎ†•</span><button class="btn-reset" onclick="resetTable('input-rows')">Ï¥àÍ∏∞Ìôî</button></div>
        <div class="select-group">
            <select id="global-unit-sel">
                <option value="kgf">kgf</option>
                <option value="gf">gf</option>
                <option value="kn">kN</option>
                <option value="n">N</option>
                <option value="lbf">lbf (ibf)</option>
            </select>
        </div>
        <table><thead><tr><th width="30">#</th><th>Ï∏°Ï†ïÍ∞í (Input)</th><th>Í∏∞Ï§ÄÍ∏∞ ÏÉÅÏàò (Ref)</th></tr></thead><tbody id="input-rows"></tbody></table>
        <button class="btn-calc" onclick="calculateAll()">Í≥ÑÏÇ∞</button>
    </div>

    <div id="capture-area">
        <div id="result-area"></div>
        <div id="info-section" class="info-section">
            <div class="info-group"><label>ÏóÖÏ≤¥Î™Ö</label><input type="text" id="company-name" placeholder="ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></div>
            <div class="info-group"><label>Ï†úÏ°∞ÏÇ¨</label><input type="text" id="manufacturer" placeholder="ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></div>
            <div class="info-group"><label>S/N</label><input type="text" id="serial-number" placeholder="ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></div>
        </div>
    </div>
    <button id="share-btn" class="btn-share" onclick="shareAsImage()">Í≤∞Í≥º Í≥µÏú† (Ïù¥ÎØ∏ÏßÄÎ°ú Ï†ÄÏû•)</button>

    <div class="section" style="border-style: dashed; background: #fafafa; margin-top: 15px;">
        <div class="section-title"><span>üîÑ Îã®ÏúÑ Î≥ÄÌôò Í≥ÑÏÇ∞Í∏∞</span><button class="btn-reset" style="background:#6c757d" onclick="resetConverter()">Ï¥àÍ∏∞Ìôî</button></div>
        <div class="conv-grid">
            <div><label style="font-size:0.7rem; color:#666;">kgf</label><input type="number" id="c-kgf" oninput="convertUnits('kgf')"></div>
            <div><label style="font-size:0.7rem; color:#666;">gf</label><input type="number" id="c-gf" oninput="convertUnits('gf')"></div>
            <div><label style="font-size:0.7rem; color:#666;">kN</label><input type="number" id="c-kn" oninput="convertUnits('kn')"></div>
            <div><label style="font-size:0.7rem; color:#666;">N</label><input type="number" id="c-n" oninput="convertUnits('n')"></div>
        </div>
    </div>
</div>

<script>
    const convFactors = { kn: 1, n: 1000, kgf: 101.9716, gf: 101971.6, lbf: 224.8089 };
    let currentRows = 5;
    let loadCellDB = [
        {"name":"BONGSHIN / 500 N","sn":"X12286","a":39.98035,"b":2.474438e-05,"c":7.938702e-08,"cap":500,"calcUnit":"n"},
        {"name":"BONGSHIN / 1 kN","sn":"P18211","a":19.98944,"b":-9.063061e-06,"c":1.64958e-08,"cap":1,"calcUnit":"n"},
        {"name":"BONGSHIN / 2 kN","sn":"O39969","a":10.0023,"b":-2.603319e-06,"c":1.189028e-09,"cap":2,"calcUnit":"n"},
        {"name":"HBM / 2 kN","sn":"352916A","a":10.00164,"b":-1.279602e-06,"c":2.138041e-10,"cap":2,"calcUnit":"n"},
        {"name":"HBM / 5 kN","sn":"032593A","a":4.002789,"b":1.1138e-06,"c":-1.915273e-10,"cap":5,"calcUnit":"n"},
        {"name":"POINT / 10 kN","sn":"C9T0105","a":1998.678,"b":-0.028778,"c":0.015466,"cap":10,"calcUnit":"kn"},
        {"name":"BONGSHIN / 10 kN","sn":"X50243","a":1997.558,"b":0.21389,"c":0.0083516,"cap":10,"calcUnit":"kn"},
        {"name":"BONGSHIN / 30 kN","sn":"O08300","a":666.7137,"b":-0.005792,"c":0.0002647,"cap":30,"calcUnit":"kn"},
        {"name":"BONGSHIN / 30 kN","sn":"R25323","a":666.6861,"b":-0.010685,"c":0.0003837,"cap":30,"calcUnit":"kn"},
        {"name":"BONGSHIN / 30 kN","sn":"W27372","a":665.2203,"b":0.072874,"c":-0.0008043,"cap":30,"calcUnit":"kn"},
        {"name":"BONGSHIN / 50 kN","sn":"V44443","a":398.4546,"b":0.041154,"c":-0.0001985,"cap":50,"calcUnit":"kn"},
        {"name":"BONGSHIN / 100 kN","sn":"R23681","a":200.9349,"b":-0.008265,"c":-3.695338e-06,"cap":100,"calcUnit":"kn"},
        {"name":"POINT / 100 kN","sn":"KT1031","a":200.6634,"b":-0.005519,"c":-1.079894e-05,"cap":100,"calcUnit":"kn"},
        {"name":"KOLAS / 100 kN","sn":"E2T1012","a":198.3617,"b":0.024976,"c":-7.817969e-05,"cap":100,"calcUnit":"kn"},
        {"name":"BONGSHIN / 300 kN","sn":"R34358","a":67.01353,"b":-0.00119,"c":1.542032e-07,"cap":300,"calcUnit":"kn"},
        {"name":"POINT / 300 kN","sn":"P20141","a":66.90203,"b":-0.000948,"c":5.236033e-07,"cap":300,"calcUnit":"kn"},
        {"name":"POINT / 500 kN","sn":"KT5062","a":40.08622,"b":-5.878e-05,"c":-1.771e-07,"cap":500,"calcUnit":"kn"},
        {"name":"POINT / 500 kN","sn":"PT50116","a":39.9433,"b":0.000108,"c":3.235e-08,"cap":500,"calcUnit":"kn"},
        {"name":"BONGSHIN / 500 kN","sn":"R34368","a":40.25535,"b":-0.000471,"c":2.727e-08,"cap":500,"calcUnit":"kn"},
        {"name":"POINT / 1 000 kN","sn":"P20143","a":20.05506,"b":-5.919e-05,"c":-1.41e-10,"cap":1000,"calcUnit":"kn"},
        {"name":"POINT / 2 000 kN","sn":"KT20275","a":10.0291,"b":-7.23e-06,"c":-3.236e-09,"cap":2000,"calcUnit":"kn"},
        {"name":"POINT / 5 000 kN","sn":"PT5016","a":4.01864,"b":-2.99e-06,"c":-2.757e-11,"cap":5000,"calcUnit":"kn"},
        {"name":"WONBANG / 10 MN","sn":"WB-2411","a":2.0126,"b":-1.731e-06,"c":5.555e-11,"cap":10000,"calcUnit":"kn"},
        {"name":"WONBANG / 10 MN","sn":"WB-121001","a":2.009767,"b":-1.137e-06,"c":1.178e-11,"cap":10000,"calcUnit":"kn"},
        {"name":"AND / 5 kN","sn":"C6313766","a":3.998388,"b":4.328e-08,"c":-1.465e-11,"cap":5,"calcUnit":"n"}
    ];

    function init() {
        const savedData = localStorage.getItem('customLoadCellDB');
        if (savedData) loadCellDB = JSON.parse(savedData);
        updateDropdown();
        renderCalTable();
        const inputRows = document.getElementById('input-rows');
        inputRows.innerHTML = '';
        for(let i=0; i<5; i++) {
            inputRows.innerHTML += `<tr><td>${i+1}</td><td><input type="number" class="comp-val"></td><td><input type="number" class="ref-const"></td></tr>`;
        }
    }

    function updateDropdown() {
        const dbSelect = document.getElementById('load-cell-db');
        dbSelect.innerHTML = '<option value="">-- Í∏∞Ï§Ä Ïû•ÎπÑ ÏÑ†ÌÉù (DB Î°úÎìú) --</option>';
        loadCellDB.forEach((item, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.textContent = `${item.name} (${item.sn})`;
            dbSelect.appendChild(opt);
        });
    }

    function triggerFileUpload() {
        if (confirm("Ï∂îÏßÑÏóÖÎ¨¥ ÌûòÍ≥ÑÏÇ∞Í∏∞ ÏµúÏã† ÌååÏùº Ï≤®Î∂ÄÌïòÏãúÏò§.\nÎ∏åÎùºÏö∞Ï†Ä Ï∫êÏãúÎ•º ÏßÄÏö∞ÏßÄ ÏïäÎäî Ìïú Í∏∞Î≥∏ Í∞íÏúºÎ°ú Ïú†ÏßÄÎê©ÎãàÎã§.")) {
            document.getElementById('excel-input').click();
        }
    }

    function processExcel(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            if (jsonData.length > 0) {
                loadCellDB = jsonData;
                localStorage.setItem('customLoadCellDB', JSON.stringify(jsonData));
                updateDropdown();
                alert("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.");
            } else {
                alert("ÏóëÏÖÄ ÌååÏùºÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function toggleRows() {
        currentRows = (currentRows === 5) ? 10 : 5;
        document.getElementById('toggle-row-btn').textContent = (currentRows === 5) ? "10Ïπ∏" : "5Ïπ∏";
        renderCalTable();
        applyLoadCell();
    }

    function renderCalTable() {
        const thead = document.getElementById('cal-thead');
        const tbody = document.getElementById('cal-table');
        tbody.innerHTML = '';
        if (currentRows === 5) {
            thead.innerHTML = `<tr><th width="30">#</th><th>ÌïòÏ§ë</th><th>Í∏∞Ï§Ä ÏÉÅÏàò</th></tr>`;
            for(let i=0; i<5; i++) {
                tbody.innerHTML += `<tr><td>${i+1}</td><td><input type="number" class="kn-val" data-idx="${i}"></td><td><input type="number" class="const-val" data-idx="${i}"></td></tr>`;
            }
        } else {
            thead.innerHTML = `<tr><th width="25">#</th><th>ÌïòÏ§ë</th><th>ÏÉÅÏàò</th><th width="25">#</th><th>ÌïòÏ§ë</th><th>ÏÉÅÏàò</th></tr>`;
            for(let i=0; i<5; i++) {
                tbody.innerHTML += `<tr><td style="background:#f9f9f9">${i+1}</td><td><input type="number" class="kn-val" data-idx="${i}"></td><td><input type="number" class="const-val" data-idx="${i}"></td><td style="background:#f9f9f9">${i+6}</td><td><input type="number" class="kn-val" data-idx="${i+5}"></td><td><input type="number" class="const-val" data-idx="${i+5}"></td></tr>`;
            }
        }
    }

    function applyLoadCell() {
        const selectedIdx = document.getElementById('load-cell-db').value;
        if(selectedIdx === "") return;
        const item = loadCellDB[selectedIdx];
        document.getElementById('ref-unit-sel').value = (item.calcUnit === 'n') ? 'n' : 'kn';
        for(let i=1; i<=currentRows; i++) {
            const load_kn = (item.cap / currentRows) * i;
            const X = (item.calcUnit === 'n') ? (item.cap === 500 ? (500/currentRows*i) : load_kn * 1000) : load_kn;
            const constant = (item.a * X) + (item.b * Math.pow(X, 2)) + (item.c * Math.pow(X, 3));
            const knInput = document.querySelector(`.kn-val[data-idx="${i-1}"]`);
            const constInput = document.querySelector(`.const-val[data-idx="${i-1}"]`);
            if(knInput && constInput) {
                knInput.value = (item.calcUnit === 'n' && item.cap !== 500) ? (load_kn * 1000).toFixed(0) : load_kn.toFixed(0);
                constInput.value = Math.round(constant);
            }
        }
    }

    function calculateAll() {
        const refUnit = document.getElementById('ref-unit-sel').value;
        const knT = Array.from(document.querySelectorAll('.kn-val')).sort((a,b) => a.dataset.idx - b.dataset.idx).map(i => {
            let v = parseFloat(i.value); return (v && refUnit === 'n') ? v / 1000 : v;
        });
        const csT = Array.from(document.querySelectorAll('.const-val')).sort((a,b) => a.dataset.idx - b.dataset.idx).map(i => parseFloat(i.value));
        const unit = document.getElementById('global-unit-sel').value;
        const resA = document.getElementById('result-area');
        resA.innerHTML = '<span class="section-title" style="margin-top:10px;">Í≤∞Í≥º</span>';
        const displayUnit = (unit === 'gf' || unit === 'n') ? 'N' : 'kN';
        const factor = displayUnit === 'N' ? 1000 : 1;
        let hasResult = false;
        document.querySelectorAll('#input-rows tr').forEach((row, idx) => {
            const val = parseFloat(row.querySelector('.comp-val').value);
            const ref = parseFloat(row.querySelector('.ref-const').value);
            if (isNaN(val) || isNaN(ref)) return;
            let bI = -1, mD = Infinity;
            for(let j=0; j<currentRows; j++) {
                if (isNaN(csT[j])) continue;
                let d = Math.abs(csT[j] - ref); if(d < mD) { mD = d; bI = j; }
            }
            if (bI === -1 || !knT[bI]) return;
            const slope = csT[bI] / knT[bI];
            const valInDisplayUnit = (val / convFactors[unit]) * factor;
            const refInDisplayUnit = (ref / slope) * factor;
            const errP = ((valInDisplayUnit - refInDisplayUnit) / refInDisplayUnit) * 100;
            hasResult = true;
            resA.innerHTML += `<div class="result-item"><strong>Ï∏°Ï†ï${idx+1}</strong> | <span class="error-text" style="color:${errP>=0?'#007bff':'#d93025'}">${errP>=0?'+':''}${errP.toFixed(3)}%</span><br><span>Ï∏°Ï†ïÍ∞í ${valInDisplayUnit.toFixed(3)}${displayUnit} Í∏∞Ï§ÄÍ∞í ${refInDisplayUnit.toFixed(3)}${displayUnit}</span></div>`;
        });
        if(hasResult) { document.getElementById('info-section').style.display = 'block'; document.getElementById('share-btn').style.display = 'block'; }
    }

    function convertUnits(type) {
        const v = parseFloat(document.getElementById('c-' + type).value);
        if (isNaN(v)) return;
        const kn = v / convFactors[type];
        for (let u in convFactors) if (u !== type && document.getElementById('c-' + u)) document.getElementById('c-' + u).value = (kn * convFactors[u]).toFixed(3);
    }

    async function shareAsImage() {
        const captureArea = document.getElementById('capture-area');
        const inputs = captureArea.querySelectorAll('input');
        const tempSpans = [];
        inputs.forEach(input => {
            const span = document.createElement('span');
            span.innerText = input.value || '(ÎØ∏ÏûÖÎ†•)';
            span.style.cssText = 'font-size:14px; font-weight:bold; color:#333;';
            input.style.display = 'none';
            input.parentNode.appendChild(span);
            tempSpans.push({ input, span });
        });
        const canvas = await html2canvas(captureArea, { backgroundColor: "#ffffff", scale: 2 });
        const link = document.createElement('a');
        link.href = canvas.toDataURL();
        link.download = `Result_${new Date().getTime()}.png`;
        link.click();
        tempSpans.forEach(t => { t.input.style.display = 'block'; t.span.remove(); });
    }
    function resetTable(id) { document.querySelectorAll(`#${id} input`).forEach(i => i.value = ''); }
    function resetConverter() { document.querySelectorAll('.conv-grid input').forEach(i => i.value = ''); }
    window.onload = init;
</script>
</body>
</html>
