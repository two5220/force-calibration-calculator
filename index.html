<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Force Calibration Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 10px; background-color: #f8f9fa; color: #333; margin: 0; }
        .container { max-width: 100%; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .header-area { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h2 { color: #007bff; font-size: 1.3rem; margin: 0; }
        .creator-tag { color: #adb5bd; font-size: 0.8rem; font-weight: bold; margin-top: 5px; display: block; }
        
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 10px; background: #fff; }
        .section-title { font-weight: bold; font-size: 1rem; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        
        input, select { width: 100%; height: 44px; padding: 8px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .upload-area { border: 2px dashed #007bff; text-align: center; padding: 25px 10px; cursor: pointer; background: #f0f7ff; border-radius: 8px; margin-bottom: 10px; }
        
        #status { font-size: 0.8rem; text-align: center; color: #fd7e14; margin-bottom: 5px; font-weight: bold; }
        .guide-text { font-size: 0.75rem; color: #007bff; background: #e7f1ff; padding: 10px; border-radius: 5px; margin-bottom: 15px; line-height: 1.4; }
        
        .table-wrapper { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 280px; }
        th, td { border: 1px solid #dee2e6; padding: 10px 5px; text-align: center; font-size: 0.85rem; }
        th { background: #f1f3f5; }
        
        .btn-calc { width: 100%; padding: 16px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-reset { padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        
        .result-item { padding: 12px; margin-bottom: 8px; border-left: 5px solid #28a745; background: #f4faf6; border-radius: 6px; font-size: 0.9rem; }
        .converter-container { display: flex; flex-direction: column; gap: 8px; }
        .conv-box { display: flex; align-items: center; gap: 8px; }
        .conv-box label { min-width: 50px; font-weight: bold; font-size: 0.8rem; color: #666; }
        canvas { display: none; } /* ì „ì²˜ë¦¬ìš© ìº”ë²„ìŠ¤ ìˆ¨ê¹€ */
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <h2>FORCE CALIBRATION CALCULATOR</h2>
        <span class="creator-tag">Created by D</span>
    </div>

    <div class="section">
        <div class="section-title">
            <span>1ë‹¨ê³„: ê¸°ì¤€ê¸° ë°ì´í„° (ì¸ì‹ ê°•í™”)</span>
            <button class="btn-reset" onclick="resetTable('cal-table')">ì´ˆê¸°í™”</button>
        </div>
        <div class="upload-area" onclick="document.getElementById('image-input').click()">
            <strong>ğŸ“¸ ì„±ì ì„œ ì‚¬ì§„ ì—…ë¡œë“œ / ì´¬ì˜</strong>
            <input type="file" id="image-input" accept="image/*" style="display:none;">
        </div>
        <div id="status">í‘œì˜ ì™¼ìª½ 2ì—´ ìˆ«ìë§Œ ì§‘ì¤‘ ë¶„ì„í•©ë‹ˆë‹¤.</div>
        <div class="guide-text">
            â€» 'ì¦ê°€ì‹œ í‰ê·  ìˆœ ì§€ì‹œê°’'ì„ ê¸°ì¤€ìœ¼ë¡œ ì¸ì‹í•˜ë©°, 0 ê°’ì€ ì œì™¸ë©ë‹ˆë‹¤. <b>ì •ë©´ì—ì„œ ë°ê²Œ ì°ìœ¼ë©´ ì¸ì‹ë¥ ì´ ë” ì˜¬ë¼ê°‘ë‹ˆë‹¤.</b>
        </div>
        
        <div style="margin-bottom: 10px;">
            <label style="font-size: 0.85rem; font-weight: bold;">í•˜ì¤‘ ë‹¨ìœ„</label>
            <select id="ref-unit-sel">
                <option value="kn">kN (í‚¬ë¡œë‰´í„´)</option>
                <option value="n">N (ë‰´í„´)</option>
            </select>
        </div>

        <div class="table-wrapper">
            <table>
                <thead><tr><th width="30">#</th><th>í•˜ì¤‘</th><th>ê¸°ì¤€ ìƒìˆ˜</th></tr></thead>
                <tbody id="cal-table"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <div class="section-title">
            <span>2ë‹¨ê³„: ì¸¡ì •ê°’ ì…ë ¥</span>
            <button class="btn-reset" onclick="resetTable('input-rows')">ì´ˆê¸°í™”</button>
        </div>
        <table>
            <thead><tr><th width="30">#</th><th>ë¹„êµê°’ (Input)</th><th>ê¸°ì¤€ê¸° ìƒìˆ˜ (Ref)</th></tr></thead>
            <tbody id="input-rows"></tbody>
        </table>
        <button class="btn-calc" onclick="calculateAll()">ë¶„ì„ ì‹œì‘</button>
    </div>

    <div id="result-area"></div>

    <div class="section" style="border-style: dashed; background: #fafafa;">
        <div class="section-title">
            <span>ğŸ”„ ë‹¨ìœ„ ë³€í™˜ ê³„ì‚°ê¸°</span>
            <button class="btn-reset" style="background:#6c757d" onclick="resetConverter()">ì´ˆê¸°í™”</button>
        </div>
        <div class="converter-container">
            <div class="conv-box"><label>kgf</label><input type="number" id="c-kgf" oninput="convertUnits('kgf')"></div>
            <div class="conv-box"><label>gf</label><input type="number" id="c-gf" oninput="convertUnits('gf')"></div>
            <div class="conv-box"><label>kN</label><input type="number" id="c-kn" oninput="convertUnits('kn')"></div>
            <div class="conv-box"><label>N</label><input type="number" id="c-n" oninput="convertUnits('n')"></div>
            <div class="conv-box"><label>lbf</label><input type="number" id="c-lbf" oninput="convertUnits('lbf')"></div>
        </div>
    </div>
</div>

<canvas id="preprocess-canvas"></canvas>

<script>
    const convFactors = { kn: 1, n: 1000, kgf: 101.9716, gf: 101971.6, lbf: 224.8089 };
    const calTable = document.getElementById('cal-table');
    const inputRows = document.getElementById('input-rows');
    
    for(let i=0; i<10; i++) calTable.innerHTML += `<tr><td>${i+1}</td><td><input type="number" class="kn-val"></td><td><input type="number" class="const-val"></td></tr>`;
    for(let i=0; i<5; i++) inputRows.innerHTML += `<tr><td>${i+1}</td><td><input type="number" class="comp-val"></td><td><input type="number" class="ref-const"></td></tr>`;

    function resetTable(id) {
        if(!confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        document.querySelectorAll(`#${id} input`).forEach(i => i.value = '');
    }
    function resetConverter() { document.querySelectorAll('.converter-container input').forEach(i => i.value = ''); }

    // ğŸ“¸ ì´ë¯¸ì§€ ì „ì²˜ë¦¬ í•¨ìˆ˜ (í‘ë°± ëŒ€ë¹„ ê°•í™”)
    function preprocess(img) {
        const canvas = document.getElementById('preprocess-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const gray = data[i] * 0.3 + data[i+1] * 0.59 + data[i+2] * 0.11;
            const contrast = gray > 128 ? 255 : 0; // ì´ì§„í™” (B&W)
            data[i] = data[i+1] = data[i+2] = contrast;
        }
        ctx.putImageData(imageData, 0, 0);
        return canvas.toDataURL();
    }

    document.getElementById('image-input').addEventListener('change', async (e) => {
        const file = e.target.files[0]; if (!file) return;
        const status = document.getElementById('status'); status.innerText = "ğŸŒ€ ì „ì²˜ë¦¬ ë° ë¶„ì„ ì¤‘...";

        const reader = new FileReader();
        reader.onload = async (event) => {
            const img = new Image();
            img.onload = async () => {
                const processedURL = preprocess(img); // í‘ë°± ë³€í™˜ ì ìš©
                
                try {
                    const worker = await Tesseract.createWorker('eng');
                    await worker.setParameters({ tessedit_char_whitelist: '0123456789' });
                    
                    const { data } = await worker.recognize(processedURL);
                    const words = data.words.map(w => ({
                        text: parseInt(w.text),
                        x: w.bbox.x0,
                        y: w.bbox.y0
                    })).filter(w => !isNaN(w.text) && w.text !== 0);

                    // 1. í–‰ ê·¸ë£¹í™” (Yì¢Œí‘œ ê¸°ì¤€)
                    let rows = [];
                    words.forEach(word => {
                        let row = rows.find(r => Math.abs(r[0].y - word.y) < 25);
                        if (row) row.push(word); else rows.push([word]);
                    });

                    // 2. í–‰ ë‚´ë¶€ ì •ë ¬(Xì¶•) ë° ì „ì²´ í–‰ ì •ë ¬(Yì¶•)
                    rows.forEach(r => r.sort((a, b) => a.x - b.x));
                    rows.sort((a, b) => a[0].y - b[0].y);

                    const knI = document.querySelectorAll('.kn-val'), csI = document.querySelectorAll('.const-val');
                    let fillIdx = 0;
                    rows.forEach(row => {
                        if (row.length >= 2 && fillIdx < 10) {
                            // ì™¼ìª½ í•˜ë‹¨ ì˜ì—­ì´ë¯€ë¡œ, ê°€ì¥ ì™¼ìª½ 2ê°œ ê°’ì„ ê°€ì ¸ì˜´
                            knI[fillIdx].value = row[0].text;
                            csI[fillIdx].value = row[1].text;
                            fillIdx++;
                        }
                    });
                    status.innerText = fillIdx > 0 ? "âœ… ì¸ì‹ ì„±ê³µ! ê°’ì„ í™•ì¸í•˜ì„¸ìš”." : "âŒ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
                    await worker.terminate();
                } catch(err) { status.innerText = "âŒ ì¸ì‹ ì˜¤ë¥˜ ë°œìƒ."; }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    function calculateAll() {
        const refUnit = document.getElementById('ref-unit-sel').value;
        const knT = Array.from(document.querySelectorAll('.kn-val')).map(i => {
            let val = parseFloat(i.value);
            return refUnit === 'n' ? val / 1000 : val;
        });
        const csT = Array.from(document.querySelectorAll('.const-val')).map(i => parseFloat(i.value));
        const resA = document.getElementById('result-area');
        const unit = document.getElementById('global-unit-sel')?.value || 'kgf';

        resA.innerHTML = '<span class="section-title">ğŸ“Š ë¶„ì„ ê²°ê³¼</span>';
        document.querySelectorAll('#input-rows tr').forEach((row, idx) => {
            const val = parseFloat(row.querySelector('.comp-val').value);
            const ref = parseFloat(row.querySelector('.ref-const').value);
            if (isNaN(val) || isNaN(ref)) return;

            const valInKN = val / convFactors[unit];
            let bI = 0, mD = Math.abs(csT[0] - ref);
            for(let j=1; j<knT.length; j++) {
                let d = Math.abs(csT[j] - ref); if(d < mD) { mD = d; bI = j; }
            }
            if (!knT[bI]) return;

            const slope = csT[bI] / knT[bI];
            const convInd = valInKN * slope;
            const errP = ((convInd - ref) / ref) * 100;

            resA.innerHTML += `<div class="result-item"><strong>${idx+1}ë²ˆ</strong> | ì˜¤ì°¨: <span style="font-weight:bold; color:${errP>=0?'#007bff':'#d93025'}">${errP.toFixed(4)}%</span><br><small>ê¸°ì¤€: ${knT[bI]}kN | í™˜ì‚°: ${convInd.toFixed(2)}</small></div>`;
        });
        window.scrollTo({ top: resA.offsetTop - 20, behavior: 'smooth' });
    }

    function convertUnits(type) {
        const val = parseFloat(document.getElementById('c-' + type).value);
        if (isNaN(val)) return;
        const vInKN = val / convFactors[type];
        for (let u in convFactors) if (u !== type) document.getElementById('c-' + u).value = (vInKN * convFactors[u]).toFixed(4);
    }
</script>
</body>
</html>
